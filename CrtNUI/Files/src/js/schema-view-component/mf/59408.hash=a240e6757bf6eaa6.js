(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[59408],{59408:(T,k,c)=>{c.r(k),c.d(k,{AddonInfo:()=>S,AddonSchema:()=>f,BaseDesignItem:()=>v,BaseSchema:()=>y,BaseSchemaParameter:()=>b,ClientUnitSchema:()=>C,ImageListSchemaItem:()=>z,Message:()=>V,MessageDirection:()=>U,MessageMode:()=>x,MetaItem:()=>u,MetaItemArray:()=>l,Package:()=>I,PackageType:()=>w,SchemaLocalizableStringDuplicateCleaner:()=>R,SchemaLocalizableStringModel:()=>_,SchemaParameter:()=>p});var L=c(38495),E=c(20442),n=c(21018),P=c(62278),m=c(36486);class f extends n.BaseSchema{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources,this.useFullHierarchy=e.useFullHierarchy}clone(){return new f(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class S{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,L.generateGuid)(),e[0]instanceof S){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get schema$(){return this._isLoaded?(0,P.of)(this._schema):this._loadSchema()}get isChanged(){return this._isChanged}get resources(){return this._resources}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get addonConfig(){return this.schema$.pipe((0,m.map)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,P.forkJoin)([this.schema$,e]).subscribe(([t,a])=>{t.addonConfig=a,this._isChanged=!0})}_setMetadataDefValues(e){this.addonName===n.AddonName.BusinessRule&&e.rules?.forEach(a=>{a.name=a.name||(0,E.generateBusinessRuleName)(),a.enabled=a.enabled||a.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const a=t.key.split(".");return{key:[a[2],a[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,m.tap)(e=>{e.success&&(this._schema=new f(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,m.map)(()=>this._schema),(0,m.share)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,m.map)(e=>e.success),(0,m.tap)(()=>{this._isChanged=!1})):(0,P.of)(!0)}clone(){return new S(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(a=>a.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(a=>a.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}class u{constructor(e){e&&(this.uId=e.uId,this.name=e.name,this.parentSchemaUId=e.parentSchemaUId),this.uId=this.uId||(0,L.generateGuid)()}update(e){this.uId=e.uId,this.name=e.name}equal(e){if(e==null)return!1;let t=this.uId===e.uId&&this.name===e.name;return(this.parentSchemaUId||e.parentSchemaUId)&&(t=t&&this.parentSchemaUId===e.parentSchemaUId),t}clone(){return new u(this)}getLocalizableValues(e){}loadLocalizableValues(e,t=!1){}}class I{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new I(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class v extends u{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new I(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let a=t.requiredSchemas;a&&(a=[...a]);let i=t.requiredEntityColumns;i&&(i=i.map(s=>({entitySchemaName:s.entitySchemaName,columnPaths:[...s.columnPaths]}))),this.dependencies={requiredSchemas:a,requiredEntityColumns:i}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class l extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,L.generateGuid)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const a=e?.findItem(t.uId);return t.equal(a)})}clone(){return new l(this)}getLocalizableValues(e,t){this.forEach(a=>{const i={};a.getLocalizableValues(i),Object.entries(i).forEach(([s,h])=>{e[`${t}.${a.name}.${s}`]=h})})}loadLocalizableValues(e,t,a=!1){const i={};Object.entries(e).map(([s,h])=>{const d=s.split("."),o=d.shift(),A=d.shift(),g=d.join(".");return{itemGroupName:o,itemName:A,itemResourceName:g,values:h}}).filter(({itemGroupName:s})=>s===t).forEach(({itemName:s,itemResourceName:h,values:d})=>{const o=i[s]??{};o[h]=d,i[s]=o}),Object.entries(i).forEach(([s,h])=>{this.find(o=>o.name===s).loadLocalizableValues(h,a)})}}class y extends v{constructor(e){super(e),this.caption=new n.LocalizableStringArray,this.localizableStrings=new l,this.description=new n.LocalizableStringArray,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new n.LocalizableStringArray(e.caption),this.description=new n.LocalizableStringArray(e.description)}equal(e){return e==null?!1:super.equal(e)&&(0,n.areLocalizableStringsEqual)(this.caption,e.caption,!0)&&(0,n.areLocalizableStringsEqual)(this.description,e.description,!0)}clone(){return new y(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}}class _ extends u{constructor(e){super(e),this.values=new n.LocalizableStringArray(e?.values)}clone(){return new _(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.values=this.values.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.values.setValues(e.values,t)}}class p extends u{constructor(e){super(e),e&&(this.caption=new n.LocalizableStringArray(e.caption),this.type=e.type,this.lookup=e.lookup,this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value,this.itemProperties=this._mapItemArray(e.itemProperties))}static updateLookupValue(e,t,a){const i=e[a]?e[a].key:null;i?t[a]=i:delete t[a]}_getSourceType(e){return e.type?.key}_mapItemArray(e){return e?new l(e.map(t=>new p(t))):new l}_resetItemProperties(e){this.type!==e&&(this.itemProperties=new l,this.itemProperties.uId=this.uId)}updateDescription(e){this.caption=e.caption,this.name=e.name;const t=this._getSourceType(e);this._resetItemProperties(t),this.type=t,p.updateLookupValue(e,this,"lookup"),this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value}clone(){return new p(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),this.itemProperties.getLocalizableValues(e,"itemProperties")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.itemProperties.loadLocalizableValues(e,"itemProperties",t)}}class b extends y{constructor(e){super(e),this.parameters=new l,e&&(this.parameters=e.parameters.clone())}_findNestedProperties(e,t){const a=t.find(i=>i.uId===e);return a?a.itemProperties:null}_getNestedParametersGroup(e,t){return(0,n.findCollectionRecursive)(t,a=>this._findNestedProperties(e,a),a=>a.itemProperties)}_getParametersGroup(e,t){let a=this._getNestedParametersGroup(e,t);return a||(a=this.parameters.uId===e?this.parameters:null),a}_getParameter(e,t){return(0,n.findItemRecursive)(t,a=>a.uId===e,a=>a.itemProperties)}findChildrenItem(e){return this._getParameter(e,this.parameters)||super.findChildrenItem(e)}findGroup(e){const t=this._getParametersGroup(e,this.parameters);return t||super.findGroup(e)}findNestedParametersGroup(e){return this._getNestedParametersGroup(e,this.parameters)||this.parameters}findParameterByUId(e){return this._getParameter(e,this.parameters)}clone(){return new b(this)}getLocalizableValues(e){super.getLocalizableValues(e),this.parameters.getLocalizableValues(e,"parameters")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.parameters.loadLocalizableValues(e,"parameters",t)}}var M=c(59131),N=c(28399);class C extends b{constructor(e){super(e),this._markerCommentsTemplate="(\\/\\*\\*PROPERTY_NAME\\*\\/)([\\s\\S]*)(\\/\\*\\*PROPERTY_NAME\\*\\/)",this.messages=new l,this.images=new l,this.onMetaItemsChanged=new M.EventEmitter,this.useFullHierarchy=!1,this.optionalProperties=[],e&&(this.group=e.group,this.schemaType=e.schemaType,this.schemaVersion=e.schemaVersion,this.parent=(0,N.cloneDeep)(e.parent),this.less=e.less,this.extendParent=e.extendParent,e.messages&&(this.messages=e.messages.clone()),e.images&&(this.images=e.images.clone()),e.addons&&e.addons.length>0&&(this.addons=e.addons),e.addonTypes&&e.addonTypes.length>0&&(this.addonTypes=[...e.addonTypes]),this.useFullHierarchy=e.useFullHierarchy,this.optionalProperties=(0,N.cloneDeep)(e.optionalProperties))}get isModule(){return this.schemaType===n.ClientUnitSchemaType.Module}get DefaultName(){return"ClientUnitSchema"}_setNameFromParent(){this.extendParent&&(this.name=this.parent.name)}_addUpdateImages(e){this.images.filter(a=>a.isChanged).forEach(a=>{e.images.find(s=>s.uId===a.uId).updateFile(a.data)})}_fixBodyTabs(e){return e.split(`
`).map((t,a)=>(a>0?"		":"")+t,this).join(`
`)}_getMarkerCommentsRegExp(e){return new RegExp(this._markerCommentsTemplate.replace(/PROPERTY_NAME/g,e))}updateBodySchemaName(e,t){e?.length&&(this.body=this.body?.replace(e,t))}findChildrenItem(e){return this.messages.findItem(e)||this.images.findItem(e)||super.findChildrenItem(e)}findGroup(e){return[this.messages,this.images].find(a=>a.uId===e)||super.findGroup(e)}updateDescription(e){super.updateDescription(e),this._setNameFromParent()}updateMetaItems(e){this._addUpdateImages(e),this.name=e.name,this.parent=e.parent,this.group=e.group,this.caption=new n.LocalizableStringArray(e.caption),this.description=new n.LocalizableStringArray(e.description),this.localizableStrings=new l(e.localizableStrings),this.messages=new l(e.messages),this.images=new l(e.images),this.parameters=new l(e.parameters),this.optionalProperties=(0,N.cloneDeep)(e.optionalProperties),this.onMetaItemsChanged.emit()}getSchemaBodyProperty(e){const t=this._getMarkerCommentsRegExp(e),a=this.body.match(t);return a&&a[2]}setSchemaBodyProperty(e,t){let a=JSON.stringify(t||{},null,"	");a=this._fixBodyTabs(a),this.setSchemaBody(e,a)}setSchemaBody(e,t){const a=this._getMarkerCommentsRegExp(e);this.body=this.body.replace(a,"$1"+t+"$3")}clone(){return new C(this)}}class z extends u{constructor(e){super(e),this.isChanged=!1,e&&(this._data=e.data||{},this.image=e.image,this.caption=new n.LocalizableStringArray(e.caption)),this.caption||(this.caption=new n.LocalizableStringArray)}get data(){return this._data}get image(){return this.data?.name}set image(e){!e||e===this.data?.name||Object.assign(this._data,{name:e})}static _getIsFileChanged(e,t){const a=e?.name,i=t?.name,s=a&&!i,h=i&&!a,d=i&&a&&t.size>0;return h||s||d}updateFile(e){this.isChanged=z._getIsFileChanged(this.data,e),this._data=e}clone(){return new z(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t)}}class V extends u{constructor(e){super(e),e&&(this.direction=e.direction,this.mode=e.mode)}clone(){return new V(this)}}var U;(function(r){r[r.Subscribe=0]="Subscribe",r[r.Publish=1]="Publish"})(U||(U={}));var x;(function(r){r[r.Broadcast=0]="Broadcast",r[r.PointToPoint=1]="PointToPoint"})(x||(x={}));var w;(function(r){r[r.General=0]="General",r[r.Assembly=1]="Assembly"})(w||(w={}));class R{static _getStringsInAllSchemasByName(e){const t=new Set,a=new Map;for(let i=e.length-1;i>=0;i--)for(const s of e[i].localizableStrings){const h=s.uId;if(t.has(h))continue;t.add(h);const d=s.name,o=a.get(d);o?o.unshift(s):a.set(d,[s])}return a}static _getStringsInSingleSchemaByName(e){const t=new Map;for(const a of e.localizableStrings){const i=a.name,s=t.get(i);s?s.push(a):t.set(i,[a])}return t}static _findStringInTheLastParentSchema(e,t){for(let a=t.length-1;a>=0;a--){const i=t[a];if(i.parentSchemaUId!==e.uId)return i}}static _removeStringsExcluding(e,t,a){for(const i of t)i.uId!==a.uId&&e.localizableStrings.deleteItemByUId(i.uId)}static deduplicateConsideringParents(e,t){const a=this._getStringsInAllSchemasByName([e,...t]),i=[];let s=null;for(const[h,d]of a.entries()){if(d.length===1)continue;s??=this._getStringsInSingleSchemaByName(e);const o=s.get(h)??i,g=this._findStringInTheLastParentSchema(e,d)??o[0];this._removeStringsExcluding(e,o,g),o.some(B=>B.uId===g.uId)||e.localizableStrings.addItem(g)}}}}}]);
