(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[55795],{50347:(S,E,t)=>{t.d(E,{T:()=>o});var d=t(59131),g=t.n(d);const o=new d.InjectionToken("ROUTER_OUTLET_HISTORY_VIEW_LIMIT_TOKEN")},47530:(S,E,t)=>{t.d(E,{X:()=>a});var d=t(96590),g=t.n(d),o=t(21018),y=t.n(o),c=t(23958),_=t.n(c),i=t(28399),v=t.n(i),u=t(50347),m=t(77989),s=t(59131),h=t.n(s);class a{get lastTransition(){return this._lastTransition}get length(){return this._items.length}constructor(e,r,l){this._window=e,this._featureValues=l,this._historyLimit=20,this._items=[],this._previous=-1,this._current=-1,r!==null&&(this._historyLimit=r),(this._window.__crtHistory??=[]).push(this)}_assertIndexedState(e){if(!("historyIndex"in e)||isNaN(e.historyIndex))throw new Error("History state should have historyIndex.")}_enforceHistoryLimit(){for(let e=this._current+1;e<this._items.length;e++)this.destroy(e);for(let e=0;e<this._current-this._historyLimit;e++)this.destroy(e)}destroy(e){const r=this._items[e];r?.view&&(r.view.destroy(),r.view=null)}_hasChildrenState(e){const r=e.state;return!(0,i.isEmpty)(r.children)}_getRootViewForChildrenRouting(){let e=!0;const r=this._items[this._current].state;for(let l=this._current-1;l>=0;l--){const f=this._items[l];if((0,i.isEmpty)(f)||!e)return null;if((0,c.crtStatesEqual)(r,f.state)&&e&&!(0,i.isEmpty)(f?.view?.pageRef))return f.view;e=this._hasChildrenState(f)}return null}goTo(e){this._assertIndexedState(e),this._previous=this._current,this._current=e.historyIndex;const r=this._current<this._previous,l=r&&!this._items[this._current],f=this._current===this._previous,M=this._current>this._previous;this._lastTransition={isBack:r,isReplace:f,isPush:M},!(e.silent&&!e._internalNotSilentIn8x&&!r)&&(f&&this.destroy(this._previous),(l||f||M)&&(this._items[this._current]={state:e}),M&&this._items.splice(this._current+1),this._enforceHistoryLimit())}canRestoreView(){const r=this._getCurrentView()?.pageRef;return this._current<this._previous&&!!r}_getCurrentView(){const e=this._items[this._current],r=this._hasChildrenState(e);let l;return r&&(0,i.isEmpty)(e?.view?.pageRef)&&(l=this._getRootViewForChildrenRouting()),l?new m.Pf(l.pageRef,e?.view?.modalRefs,l.schemaState,l.pageRefReusable,l.scrollPositions,this._featureValues):e?.view}getView(){if(!this.canRestoreView())throw new Error("Cannot restore view");return this._getCurrentView()}getViewByOffset(e){return this._items[this._current+e]?.view}validateBeforeStore(e){const r=this._items[this._current].view;if(r?.pageRef&&r?.pageRef!==e.pageRef)throw new Error("This history item already contain another view. If you want to change view, do replace history state first.")}storeView(e){this.validateBeforeStore(e),this._items[this._current].view=e}actualHistoryLength(){return this._items.filter(e=>e?.state?.moduleName)?.length}static{this.\u0275fac=function(r){return new(r||a)(s.\u0275\u0275inject(d.WINDOW_TOKEN),s.\u0275\u0275inject(u.T,8),s.\u0275\u0275inject(o.FEATURE_VALUES))}}static{this.\u0275prov=s.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}},37019:(S,E,t)=>{t.d(E,{p:()=>s});var d=t(73308),g=t(59131),o=t(20822),y=t(52552),c=t(21018),_=t(22438),i=t(10850),v=t(28399),u=t(62278),m=t(36486);class s extends y.BaseDataGridStateHandlerService{constructor(a,n,e,r,l,f,M){super(a),this._schemaPartsService=n,this._metadataModifierService=e,this._featureValues=r,this._dataGridDesignSettingsProvider=l,this._dataGridDesignSettingsUpdater=f,this._dataGridActiveFolderDesignSettingsProvider=M}_getActiveFolderDataGridDesignSettings(a){return this.viewModel$.pipe((0,m.switchMap)(n=>this._dataGridActiveFolderDesignSettingsProvider.get({viewConfig:a,viewModel:n,metadata:this.schemaService.schema})))}_saveSettingsForFolder(a,n){const{columns:e,viewElementConfig:r}=n,l=(0,v.cloneDeep)(e),f=a.columns?.map(p=>p?.viewMetadata);this._metadataModifierService.revert(l),this._setColumnsCaptionResourceMacros(l,f);const M=this._dataGridDesignSettingsUpdater.updateColumns(a,l,r);return this.viewModel$.pipe((0,m.switchMap)(p=>this._dataGridActiveFolderDesignSettingsProvider.set({viewConfig:r,viewModel:p,metadata:this.schemaService.schema},M)),(0,m.switchMap)(()=>this._schemaPartsService.commit({silent:!1})),(0,m.map)(()=>{}))}_setColumnsCaptionResourceMacros(a,n){(a??[]).filter(e=>e&&!(0,c.isResourceMacros)(e.caption)).forEach(e=>{const r=this._getColumnCaptionResourceKey(e,n);e.caption=(0,c.toResourceMacros)(r)})}_getColumnCaptionResourceKey(a,n){const e=n?.find(f=>f?.id&&f.id===a.id),r=(0,c.extractResourcesKey)(e?.caption),l=(0,o.createDataGridColumnCaptionResourceKey)(a);return r||l}_saveSettingsToProfile(a){var n=this;return(0,d.A)(function*(){const{columns:e,viewElementConfig:r}=a,l=(0,v.cloneDeep)(e);let f=l?.some(D=>D.changed);const M=yield n._dataGridDesignSettingsProvider.get(r.name),p=M.columns?.map(D=>D?.viewMetadata).filter(Boolean);n._metadataModifierService.revert(l),n._setColumnsCaptionResourceMacros(l,p),f=f||l?.length!==p?.length;const R=n._dataGridDesignSettingsUpdater.updateColumns(M,l,r);yield n._dataGridDesignSettingsProvider.save(r.name,R),yield n._schemaPartsService.commit({silent:f===!1})})()}innerHandle(a){return this._featureValues.DisableDataGridSettingsByFolders?(0,u.from)(this._saveSettingsToProfile(a)):this._getActiveFolderDataGridDesignSettings(a.viewElementConfig).pipe((0,m.switchMap)(n=>n?this._saveSettingsForFolder(n,a):this._saveSettingsToProfile(a)))}handle(a,n){return super.handle({...a},n)}static{this.\u0275fac=function(n){return new(n||s)(g.\u0275\u0275inject(_.SchemaService),g.\u0275\u0275inject(_.SchemaPartsService),g.\u0275\u0275inject(i.MetadataModifierService),g.\u0275\u0275inject(c.FEATURE_VALUES),g.\u0275\u0275inject(o.DataGridDesignSettingsProvider),g.\u0275\u0275inject(o.DataGridDesignSettingsUpdater),g.\u0275\u0275inject(o.DataGridActiveFolderDesignSettingsProvider))}}static{this.\u0275prov=g.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac})}}},77989:(S,E,t)=>{t.d(E,{OG:()=>g,X8:()=>d,pU:()=>c,Pf:()=>y});class d{constructor(i){i&&(this.title=i.title,this.schemaName=i.schemaName)}}class g{}var o=t(62278);class y{constructor(i=null,v=new Map,u=i?.instance?.schemaState,m=!1,s=i?.instance?.scrollPositions,h={}){this.pageRef=i,this.modalRefs=v,this.schemaState=u,this.pageRefReusable=m,this.scrollPositions=s,this._featureValues=h,this.isDestroyed=!1}_destroyModalViews(){const i=this?.modalRefs;i?.size&&(Array.from(i.values()).forEach(v=>v.close()),this.modalRefs.clear())}_destroyViewModelAsync(i){return this._featureValues.DisableHandleFixedViewModelResumePauseRequest?i?.destroy().pipe((0,o.take)(1)):(0,o.concat)(i?.pause()??(0,o.of)(),i?.destroy()??(0,o.of)()).pipe((0,o.take)(2))}destroy(){if(this._destroyModalViews(),this.pageRefReusable){const i=this.pageRef?.instance?.schemaComponent;this.schemaState.viewModel&&(i?.clearResources(this.schemaState.viewModel),this._destroyViewModelAsync(this.schemaState.viewModel).subscribe()),this.schemaState.viewModel=null,this.schemaState.models=null,this.schemaState=null}else{const i=this.pageRef?.instance?.schemaComponent?.schemaState;this._destroyViewModelAsync(i?.viewModel).subscribe(),this.pageRef?.destroy(),this.pageRef?.hostView?.destroy(),this.pageRef=null}this.isDestroyed=!0}get viewModel(){return this._featureValues?.UseSchemaOutletReuseViewStrategy?this?.schemaState?.viewModel:this?.pageRef?.instance?.schemaState?.viewModel}}class c extends Error{constructor(i){super(i),Object.setPrototypeOf(this,c.prototype)}}},31418:(S,E,t)=>{t.d(E,{P:()=>o});var d=t(59131),g=t.n(d);class o{constructor(){this._repository=new Map}set(c,_){this._repository.set(c,_)}get(c){return this._repository.get(c)}getAll(){return Array.from(this._repository.values())}static{this.\u0275fac=function(_){return new(_||o)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:o,factory:o.\u0275fac,providedIn:"root"})}}},26958:(S,E,t)=>{t.d(E,{j:()=>v});var d=t(59131),g=t.n(d),o=t(10850),y=t.n(o),c=t(36486),_=t.n(c),i=t(31418);class v extends o.DataSourceFactoryService{constructor(m,s,h){super(s,h),this._dataSourceRepository=m}create(m,s,h){return super.create(m,s,h).pipe((0,c.tap)(a=>{this._dataSourceRepository.set(m,a)}))}static{this.\u0275fac=function(s){return new(s||v)(d.\u0275\u0275inject(i.P),d.\u0275\u0275inject(d.Injector),d.\u0275\u0275inject(o.DataSourceTypeResolver))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac})}}},25343:(S,E,t)=>{t.d(E,{$:()=>i});var d=t(50456),g=t(21018),o=t(10850),y=t(62278),c=t(31418),_=t(59131);class i extends d.DataSourceStructureExplorerService{constructor(u,m,s,h){super(),this._dataSourceRepository=u,this._dataSchemaRepository=m,this._entityBackwardReferenceService=s,this._featureValues=h}getDataSchemaAttributeByPath(u){return(0,y.throwError)(new Error("Method not implemented"))}getDataSchemaByName(u){return this._dataSchemaRepository.get(u)}getDataSourceByName(u){return(0,y.of)(this._dataSourceRepository.get(u))}getDataSources(){return(0,y.of)(this._dataSourceRepository.getAll())}getDataSchemaBackReference(u){return this._featureValues.UseBackwardReferencesInStructureExplorer?this._entityBackwardReferenceService.getBackwardReferences(u):(0,y.of)([])}static{this.\u0275fac=function(m){return new(m||i)(_.\u0275\u0275inject(c.P),_.\u0275\u0275inject(o.DataSchemaRepositoryService),_.\u0275\u0275inject(d.EntityBackwardReferenceService),_.\u0275\u0275inject(g.FEATURE_VALUES))}}static{this.\u0275prov=_.\u0275\u0275defineInjectable({token:i,factory:i.\u0275fac})}}},70765:(S,E,t)=>{t.d(E,{U:()=>u});var d=t(96590),g=t(21018),o=t(10850),y=t(23958),c=t(28399),_=t(62278),i=t(47530),v=t(59131);class u extends o.ViewModelDataDelayer{constructor(s,h,a,n){super(),this._crtRouter=s,this._routerOutletHistory=h,this._featureValues=a,this._window=n,this._disableDelayingModelEventsFeatureName="DisableDelayingModelEvents",this._disableDelayingModelsEventFeatureState=!1,this._disableOffsetForDelayingModelEventsFeatureName="DisableOffsetForDelayingModelEvents",this._disableOffsetForDelayingModelEventsFeatureState=!1,this._defaultViewLoadingOffset=-1,this._subscriptions=new _.Subscription,this._loadTriggerSubject=new _.Subject,this.loadTrigger$=this._loadTriggerSubject.asObservable(),this._isAngularHost=(0,c.get)(this._window,"Terrasoft")?.isAngularHost,this._isAngularHost&&(this._initFeatureStates(),this._disableDelayingModelsEventFeatureState||this._subscribeOnNavigation())}setViewModel(s){this._viewModel||(this._viewModel=s)}_initFeatureStates(){this._disableDelayingModelsEventFeatureState=this._featureValues[this._disableDelayingModelEventsFeatureName]??!1,this._disableDelayingModelsEventFeatureState||(this._disableOffsetForDelayingModelEventsFeatureState=this._featureValues[this._disableOffsetForDelayingModelEventsFeatureName]??!1),this._viewLoadingOffset=this._disableOffsetForDelayingModelEventsFeatureState?0:this._defaultViewLoadingOffset}_shouldLoadForModals(s,h){return s&&s.modalRefs?Array.from(s.modalRefs.values()).some(a=>a?.componentInstance?.page?.schemaState?.viewModel===h):!1}_shouldLoadForPage(s,h){return s?.viewModel===h}_getViews(){const s=[];for(let h=this._viewLoadingOffset;h<=0;h++)s.push(this._routerOutletHistory.getViewByOffset(h));return s}_shouldLoadForViews(){const s=(0,o.getRootViewModel)(this._viewModel);return this._getViews().some(a=>{const n=this._shouldLoadForPage(a,s),e=this._shouldLoadForModals(a,s);return n||e})}_shouldLoad(){return this?._routerOutletHistory?this._shouldLoadForViews():!1}_subscribeOnNavigation(){this._subscriptions.add(this._crtRouter?.navigateEnd$.subscribe(()=>{this._shouldLoad()&&this._loadTriggerSubject.next()}))}shouldBeDelayed(){return!this._isAngularHost||this._disableDelayingModelsEventFeatureState?!1:this._viewModel.State===o.ViewModelStates.Paused&&!this._shouldLoad()}setState(s,h){this._disableDelayingModelsEventFeatureState||s._setStateAttribute(h)}destroy(){this._subscriptions.unsubscribe(),this._loadTriggerSubject.complete(),this._viewModel=null}ngOnDestroy(){this.destroy()}static{this.\u0275fac=function(h){return new(h||u)(v.\u0275\u0275inject(y.CrtRouter,8),v.\u0275\u0275inject(i.X,8),v.\u0275\u0275inject(g.FEATURE_VALUES),v.\u0275\u0275inject(d.WINDOW_TOKEN))}}static{this.\u0275prov=v.\u0275\u0275defineInjectable({token:u,factory:u.\u0275fac})}}}}]);
